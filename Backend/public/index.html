<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>VOID-GATE | Hub Central</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* üåå CONFIGURACI√ìN DEL UNIVERSO */
        :root {
            --void-black: #050505;
            --event-horizon: #00f7ff; /* Cian */
            --accretion-disk: #bd00ff; /* Violeta */
            --gold: #ffd700;           /* Monedas */
            --glass-bg: rgba(10, 10, 15, 0.90);
            --text-color: #e0e0e0;
        }

        body {
            background-color: var(--void-black);
            color: var(--text-color);
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px);
            background-size: 550px 550px, 350px 350px;
        }

        body::before {
            content: "";
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 150vw; height: 150vw;
            background: radial-gradient(circle, rgba(0,0,0,1) 30%, rgba(56, 12, 85, 0.4) 50%, transparent 70%);
            z-index: -1;
        }

        .void-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 3.5rem;
            text-align: center;
            letter-spacing: 5px;
            color: white;
            text-shadow: 0 0 20px var(--event-horizon);
            margin-top: 20px;
        }
        
        .void-subtitle {
            text-align: center;
            color: var(--event-horizon);
            letter-spacing: 3px;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 2rem;
        }

        .form-control {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
        }
        .form-control:focus {
            background: rgba(0, 0, 0, 0.6);
            border-color: var(--event-horizon);
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.2);
        }

        .btn-void-primary {
            background: transparent;
            border: 1px solid var(--event-horizon);
            color: var(--event-horizon);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            transition: all 0.3s;
        }
        .btn-void-primary:hover {
            background: var(--event-horizon);
            color: #000;
            box-shadow: 0 0 15px var(--event-horizon);
        }

        /* üñºÔ∏è ESTILOS PARA LAS IM√ÅGENES DE PRODUCTOS */
        .product-img-container {
            width: 100%;
            height: 120px; /* Altura fija para que todos sean iguales */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }
        .product-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* La imagen se ajusta sin recortarse */
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
        }

        .item-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: 0.2s;
            position: relative;
        }
        .item-card:hover {
            border-color: var(--event-horizon);
            transform: translateY(-3px);
            background: rgba(255,255,255,0.08);
            box-shadow: 0 5px 15px rgba(0, 247, 255, 0.1);
        }
        .item-price { color: var(--gold); font-weight: bold; font-size: 1.2rem; font-family: 'Orbitron';}
        .item-qty { 
            position: absolute; top: 10px; right: 10px; 
            background: var(--accretion-disk); color: white; 
            padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; font-weight: bold;
            z-index: 10;
        }

        .menu-btn {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.4);
            transition: all 0.3s;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-family: 'Orbitron';
        }
        .menu-btn:hover {
            transform: scale(1.03);
            border-color: var(--event-horizon);
            color: var(--event-horizon);
            background: rgba(0, 247, 255, 0.05);
        }

        .nav-tabs { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-link { color: #aaa; font-family: 'Orbitron'; border: none; background: transparent; }
        .nav-link.active { background: transparent !important; color: var(--event-horizon) !important; border-bottom: 2px solid var(--event-horizon) !important; }
        .nav-link:hover { color: white; }

        .dev-console {
            border: 1px solid #333; background: #000; padding: 15px; margin-top: 30px; font-family: 'Courier New', monospace; color: #0f0; border-radius: 6px;
        }
        .dev-title { color: var(--accretion-disk); font-weight: bold; border-bottom: 1px solid #333; margin-bottom: 10px; padding-bottom: 5px;}
        .hud-stat { font-family: 'Orbitron'; font-size: 1.2rem; border: 1px solid var(--gold); padding: 5px 15px; border-radius: 20px; color: var(--gold); background: rgba(0,0,0,0.5); }

        /* üîî TOASTS PERSONALIZADOS (NOTIFICACIONES) */
        .void-toast {
            background-color: rgba(15, 15, 20, 0.95) !important;
            border: 1px solid var(--event-horizon);
            color: white;
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.3);
        }
        .toast-header {
            background-color: rgba(255,255,255,0.1) !important;
            color: white !important;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="container py-4">
    
    <h1 class="void-title">VOID-GATE</h1>
    <p class="void-subtitle">SISTEMA DE GESTI√ìN CENTRAL</p>
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
        </div>

    <div id="authSection" class="row g-4 justify-content-center w-100">
        <div class="col-md-5">
            <div class="glass-panel h-100">
                <h4 class="text-info mb-3"><i class="bi bi-person-plus"></i> Registro</h4>
                <input id="regNombre" type="text" class="form-control mb-2" placeholder="Nombre">
                <input id="regEmail" type="email" class="form-control mb-2" placeholder="Email">
                <input id="regPassword" type="password" class="form-control mb-3" placeholder="Contrase√±a">
                <button id="btnRegistrar" class="btn btn-void-primary w-100">Crear Identidad</button>
            </div>
        </div>

        <div class="col-md-5">
            <div class="glass-panel h-100">
                <h4 class="text-white mb-3"><i class="bi bi-fingerprint"></i> Acceso</h4>
                <input id="loginEmail" type="email" class="form-control mb-2" placeholder="Email">
                <input id="loginPassword" type="password" class="form-control mb-3" placeholder="Contrase√±a">
                <button id="btnLogin" class="btn btn-outline-light w-100">Conectar</button>
                
                <div class="text-center mt-3 border-top border-secondary pt-3">
                    <small class="text-muted">¬øTienes un c√≥digo?</small><br>
                    <a href="#" id="btnOpenVerif" class="text-decoration-none text-info fw-bold">
                        <i class="bi bi-shield-check"></i> Validar Manualmente
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="verificationSection" class="row justify-content-center w-100 mt-3" style="display:none;">
        <div class="col-md-6">
            <div class="glass-panel text-center">
                <h4><i class="bi bi-shield-lock"></i> Verificaci√≥n 2FA</h4>
                <p class="text-muted">Introduce el c√≥digo recibido.</p>
                <input id="verifEmail" type="email" class="form-control mb-2" placeholder="Email">
                <input id="verifCodigo" type="text" class="form-control text-center mb-3 codigo-input" placeholder="000000" maxlength="6">
                
                <div class="d-grid gap-2">
                    <button id="btnVerificar" class="btn btn-void-primary">Verificar</button>
                    <button id="btnCloseVerif" class="btn btn-sm btn-outline-danger">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="menuSection" class="row justify-content-center w-100 mt-2" style="display:none;">
        <div class="col-lg-8">
            <div class="glass-panel text-center">
                <h3 class="mb-4" style="font-family:'Orbitron'">ESTACI√ìN DE MANDO</h3>
                <p class="text-white mb-5">Bienvenido, Comandante <span id="nombreUsuarioMenu" class="text-info fw-bold">---</span></p>

                <div class="row g-4 justify-content-center">
                    <div class="col-md-8">
                        <a href="#" id="btnIrTienda" class="menu-btn">
                            <i class="bi bi-cart3"></i> ENTRAR AL MERCADO
                        </a>
                    </div>
                    
                    <div class="col-md-8">
                        <a href="#" id="btnMenuLogout" class="menu-btn" style="border-color: #ff3860; color: #ff3860;">
                            <i class="bi bi-power"></i> DESCONECTAR SISTEMA
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameInterface" class="w-100" style="display:none;">
        
        <div class="glass-panel d-flex justify-content-between align-items-center py-2 px-4 mb-3">
            <div>
                <button id="btnVolverMenu" class="btn btn-sm btn-outline-light me-3">
                    <i class="bi bi-arrow-left"></i> HUB
                </button>
                <span id="hudNombre" class="text-info fw-bold fs-5">---</span>
            </div>
            <div>
                <span class="hud-stat"><span id="hudMonedas">0</span> CR</span>
            </div>
        </div>

        <div class="glass-panel">
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-tienda" onclick="cambiarPesta√±a('tienda')"><i class="bi bi-shop"></i> MERCADO</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-inventario" onclick="cambiarPesta√±a('inventario')"><i class="bi bi-backpack2"></i> MI INVENTARIO</button>
                </li>
            </ul>

            <div id="view-tienda">
                <div class="row" id="shop-grid"></div>
            </div>

            <div id="view-inventario" style="display:none;">
                <div class="row" id="inventory-grid">
                    <div class="text-center text-muted p-5">Tu inventario est√° vac√≠o.</div>
                </div>
            </div>
        </div>

        <div class="dev-console">
            <div class="dev-title"><i class="bi bi-terminal"></i> [DEV_MODE] :: PANEL DE CONTROL</div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="text-muted small">Inyectar Monedas:</label>
                    <div class="input-group">
                        <input id="devMonedasInput" type="number" class="form-control bg-dark text-success border-secondary" placeholder="Cantidad">
                        <button id="btnDevAddCoins" class="btn btn-outline-success border-secondary">EJECUTAR</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="text-muted small">Forja (Crear Item en DB):</label>
                    <div class="input-group">
                        <input id="devProdName" type="text" class="form-control bg-dark text-warning border-secondary" placeholder="Nombre">
                        <input id="devProdPrice" type="number" class="form-control bg-dark text-warning border-secondary" placeholder="Precio">
                        <button id="btnDevForgar" class="btn btn-outline-warning border-secondary">FORJAR</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const BASE_URL = "http://localhost:8080/dsaApp"; 
        const URL_USU = BASE_URL + "/usuarios";
        const URL_PROD = BASE_URL + "/productos";

        let currentUserEmail = null;

        // üñºÔ∏è IM√ÅGENES DE OBJETOS (A√ëADIR AQU√ç LAS URLS O RUTAS)
        // Si el nombre del producto coincide con la clave, se usar√° la imagen.
        // Si no, se pondr√° un icono por defecto.
        const IMAGENES_PRODUCTOS = {
            "Katana": "images/katana.png",
            "Jeringuilla": "images/jeringuilla.png",
            "Chaleco antibalas": "images/chaleco.png",
            "Bloque de energia": "images/energia.png"
        };

        // --- SISTEMA DE NOTIFICACIONES (TOASTS) ---
        function showNotification(mensaje, tipo = 'info') {
            let colorHeader = 'text-white';
            let icon = 'bi-info-circle';

            if(tipo === 'success') { colorHeader = 'text-success'; icon = 'bi-check-circle-fill'; }
            if(tipo === 'error')   { colorHeader = 'text-danger'; icon = 'bi-exclamation-triangle-fill'; }

            // Creamos el HTML del Toast din√°micamente
            const toastHTML = `
                <div class="toast void-toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="bi ${icon} ${colorHeader} me-2"></i>
                        <strong class="me-auto ${colorHeader}">SISTEMA</strong>
                        <small>Ahora</small>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${mensaje}
                    </div>
                </div>
            `;

            // A√±adir al contenedor
            const container = document.querySelector('.toast-container');
            container.insertAdjacentHTML('beforeend', toastHTML);

            // Inicializar y mostrar (Bootstrap)
            const toastEl = container.lastElementChild;
            const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
            toast.show();

            // Eliminar del DOM cuando termine
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }


        // --- GESTI√ìN DE PANTALLAS ---
        function mostrarLogin() {
            $("#authSection").fadeIn();
            $("#verificationSection").hide();
            $("#menuSection").hide();
            $("#gameInterface").hide();
            $("#loginEmail").val(""); $("#loginPassword").val("");
            currentUserEmail = null;
        }

        function mostrarMenu(usuario) {
            currentUserEmail = usuario.email;
            $("#authSection").hide();
            $("#verificationSection").hide();
            $("#gameInterface").hide();
            $("#menuSection").fadeIn();
            $("#nombreUsuarioMenu").text(usuario.nombre.toUpperCase());
        }

        function mostrarJuego() {
            $("#menuSection").hide();
            $("#gameInterface").fadeIn();
            actualizarDatosUsuario();
            cargarTienda();
            cambiarPesta√±a('tienda');
        }

        // --- PESTA√ëAS ---
        function cambiarPesta√±a(tab) {
            if(tab === 'tienda') {
                $("#view-tienda").show(); $("#view-inventario").hide();
                $("#tab-tienda").addClass('active'); $("#tab-inventario").removeClass('active');
            } else {
                $("#view-tienda").hide(); $("#view-inventario").show();
                $("#tab-tienda").removeClass('active'); $("#tab-inventario").addClass('active');
                cargarInventario();
            }
        }

        // --- BACKEND LOGIC ---
        function actualizarDatosUsuario() {
            if(!currentUserEmail) return;
            $.ajax({
                url: URL_USU + "/" + currentUserEmail,
                type: "GET",
                success: function(user) {
                    $("#hudNombre").text(user.nombre.toUpperCase());
                    $("#hudMonedas").text(user.monedas);
                    window.userData = user;
                    if($("#view-inventario").is(":visible")) cargarInventario();
                }
            });
        }

        function cargarTienda() {
            $.get(URL_PROD + "/", function (productos) {
                $("#shop-grid").empty();
                if(productos.length === 0) {
                    $("#shop-grid").html('<div class="text-center text-muted">Tienda vac√≠a. Usa la Forja.</div>');
                    return;
                }
                productos.forEach(p => {
                    // LOGICA DE IMAGEN: Buscamos en el mapa, si no existe, ponemos icono gen√©rico
                    let imgHTML = `<i class="bi bi-box-seam fs-1 text-white"></i>`;
                    if(IMAGENES_PRODUCTOS[p.nombreproducto]) {
                        imgHTML = `<img src="${IMAGENES_PRODUCTOS[p.nombreproducto]}" class="product-img" alt="${p.nombreproducto}">`;
                    }

                    $("#shop-grid").append(`
                        <div class="col-md-4 mb-3">
                            <div class="item-card">
                                <div class="product-img-container">
                                    ${imgHTML}
                                </div>
                                <h5 class="text-white">${p.nombreproducto}</h5>
                                <div class="item-price mb-3">${p.precio} CR</div>
                                <button class="btn btn-sm btn-void-primary w-100" onclick="comprarProducto('${p.nombreproducto}')">
                                    COMPRAR
                                </button>
                            </div>
                        </div>
                    `);
                });
            });
        }

        window.comprarProducto = function(nombreProducto) {
            const data = { nombreProducto: nombreProducto, emailUser: currentUserEmail };
            $.ajax({
                url: URL_PROD + "/comprar",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                dataType: "text",
                success: function (res) {
                    showNotification("¬°Objeto adquirido con √©xito!", "success");
                    actualizarDatosUsuario();
                },
                error: function (xhr) {
                    if (xhr.status === 402) showNotification("Cr√©ditos insuficientes.", "error");
                    else if (xhr.status === 201) {
                         showNotification("¬°Objeto adquirido!", "success");
                         actualizarDatosUsuario();
                    }
                    else showNotification("Error: " + xhr.responseText, "error");
                }
            });
        }

        function cargarInventario() {
            const user = window.userData;
            if(!user || !user.inventario) return;
            const inventario = user.inventario;
            $("#inventory-grid").empty();
            const items = Object.keys(inventario);

            if (items.length === 0) {
                $("#inventory-grid").html('<div class="text-center text-muted p-5">Inventario vac√≠o.</div>');
                return;
            }

            items.forEach(nombre => {
                const cantidad = inventario[nombre];
                // L√≥gica de imagen para inventario tambi√©n
                let imgHTML = `<i class="bi bi-backpack fs-1 text-info"></i>`;
                if(IMAGENES_PRODUCTOS[nombre]) {
                    imgHTML = `<img src="${IMAGENES_PRODUCTOS[nombre]}" class="product-img" alt="${nombre}">`;
                }

                $("#inventory-grid").append(`
                    <div class="col-md-3 mb-3">
                        <div class="item-card border-info">
                            <span class="item-qty">${cantidad}</span>
                            <div class="product-img-container">
                                ${imgHTML}
                            </div>
                            <h6 class="text-white mt-2">${nombre}</h6>
                        </div>
                    </div>
                `);
            });
        }

        // --- BUTTONS ---
        $("#btnLogin").click(function () {
            const data = { email: $("#loginEmail").val(), password: $("#loginPassword").val() };
            $.ajax({
                url: URL_USU + "/login", type: "POST", data: JSON.stringify(data), contentType: "application/json",
                success: function (res) {
                    showNotification("Acceso Concedido", "success");
                    setTimeout(() => mostrarMenu(res), 800);
                },
                error: function (xhr) { showNotification("Acceso Denegado: " + xhr.responseText, "error"); }
            });
        });

        $("#btnRegistrar").click(function () {
            const data = { nombre: $("#regNombre").val(), email: $("#regEmail").val(), password: $("#regPassword").val() };
            $.ajax({
                url: URL_USU + "/register", type: "POST", data: JSON.stringify(data), contentType: "application/json",
                success: function () {
                    showNotification("Registro iniciado. Revisa tu email.", "info");
                    $("#authSection").hide(); $("#verificationSection").fadeIn(); $("#verifEmail").val(data.email);
                },
                error: function (xhr) { showNotification("Error: " + xhr.responseText, "error"); }
            });
        });

        $("#btnIrTienda").click(function() { mostrarJuego(); });
        $("#btnVolverMenu").click(function() { $("#gameInterface").hide(); $("#menuSection").fadeIn(); });
        $("#btnMenuLogout").click(function() { mostrarLogin(); showNotification("Desconectado", "info"); });
        $("#btnOpenVerif").click(function() { $("#authSection").hide(); $("#verificationSection").fadeIn(); });
        $("#btnCloseVerif").click(function() { $("#verificationSection").hide(); $("#authSection").fadeIn(); });

        $("#btnVerificar").click(function() {
            const data = { email: $("#verifEmail").val(), codigo: $("#verifCodigo").val() };
            $.ajax({
                url: URL_USU + "/verificar-codigo", type: "POST", data: JSON.stringify(data), contentType: "application/json",
                success: function () {
                    showNotification("Verificaci√≥n completada", "success");
                    setTimeout(() => { $("#verificationSection").hide(); $("#authSection").fadeIn(); }, 1500);
                },
                error: function(xhr) { showNotification("Error: " + xhr.responseText, "error"); }
            });
        });

        $("#btnDevAddCoins").click(function() {
            const cant = $("#devMonedasInput").val();
            if(!cant || !currentUserEmail) return;
            const emailEncoded = encodeURIComponent(currentUserEmail);
            $.ajax({
                url: URL_USU + "/monedas/" + emailEncoded + "/" + cant,
                type: "PUT",
                dataType: "text",
                success: function() { 
                    actualizarDatosUsuario(); 
                    showNotification("Monedas inyectadas correctamente", "success");
                },
                error: function(xhr) { showNotification("Error (" + xhr.status + ")", "error"); }
            });
        });

        $("#btnDevForgar").click(function() {
            const data = { nombreproducto: $("#devProdName").val(), precio: parseFloat($("#devProdPrice").val()) };
            $.ajax({
                url: URL_PROD + "/", type: "POST", data: JSON.stringify(data), contentType: "application/json",
                success: function() { 
                    cargarTienda(); 
                    showNotification("Item forjado en la base de datos", "success");
                    $("#devProdName").val(""); $("#devProdPrice").val("");
                },
                error: function(xhr) { showNotification("Error al forjar", "error"); }
            });
        });

        $(".codigo-input").on('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); });

    </script>
</body>
</html>